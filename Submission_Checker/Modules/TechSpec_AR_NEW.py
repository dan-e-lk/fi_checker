#-------------------------------------------------------------------------------
# Name:         TechSpec_AR_NEW.py
# Purpose:      This module checkes every validation statements under Annual Report Tech Spec 2017
#
# Author:       NER RIAU, Ministry of Natural Resources and Forestry
#
# Created:      Sept 6, 2018
# Notes:        Any updates to this script can be found here: \\cihs.ad.gov.on.ca\mnrf\Groups\ROD\RODOpen\Forestry\Tools_and_Scripts\FI_Checker\ChangeLog
#
#-------------------------------------------------------------------------------
import arcpy
import os, sys
import Reference as R
import pprint

verbose = True

lyrInfo = {
# Lyr acronym            name                           mandatory fields                                            Data Type   Tech Spec       Tech Spec URL

    "AGG":  ["Forestry Aggregate Pits",                 ['PITID','REHABREQ','REHAB','PITCLOSE','TONNES'],           'point',    '4.3.18',       R.findPDF('FIM_AR_TechSpec_2017.pdf#page=114')],
    "EST":  ["Establishment Assessment",                ['ARDSTGRP','SILVSYS','AGEEST','YRDEP','DSTBFU','SGR',
                                                            'TARGETFU','TARGETYD','ESTIND','ESTFU','ESTYIELD',
                                                            'SPCOMP','HT','DENSITY','STKG'],                        'polygon',  '4.3.15',       R.findPDF('FIM_AR_TechSpec_2017.pdf#page=87')],

    "FTG":  ["Free-To-Grow",                            ['ARDSTGRP','YRDEP','DSTBFU','SGR','TARGETFU','FTG'],       'polygon',  '4.3.17',       R.findPDF('FIM_AR_TechSpec_2017.pdf#page=106')],

    "HRV":  ["Harvest Disturbance",                     ['BLOCKID','HARVCAT','SILVSYS','HARVMTHD','MGMTSTG',
                                                            'ESTAREA','SGR','DSTBFU','TARGETFU','TARGETYD','TRIAL',
                                                            'LOGMTHD'],                                             'polygon',  '4.3.8',        R.findPDF('FIM_AR_TechSpec_2017.pdf#page=29')],

    "NDB":  ["Natural Disturbance",                     ['NDEPCAT','VOLCON','VOLHWD','DSTBFU'],                     'polygon',  '4.3.7',        R.findPDF('FIM_AR_TechSpec_2017.pdf#page=25')],
    "PER":  ["Performance Assessment",                  ['SILVSYS','PERFU','PERYIELD','SPCOMP','BHA','HT',
                                                            'DENSITY','STKG','AGS','UGS'],                          'polygon',  '4.3.16',        R.findPDF('FIM_AR_TechSpec_2017.pdf#page=98')],

    "PRT":  ["Protection Treatment",                    ['TRTMTHD1','TRTCAT1'],                                     'polygon',  '4.3.14',       R.findPDF('FIM_AR_TechSpec_2017.pdf#page=81')],
    "RDS":  ["Road Construction and Road Use",          ['ROADID',' ROADCLAS','CONSTRCT','DECOM','TRANS','ACCESS',
                                                            'MAINTAIN','MONITOR','CONTROL1','CONTROL2'],            'arc',      '4.3.9',        R.findPDF('FIM_AR_TechSpec_2017.pdf#page=44')],

    "RGN":  ["Regeneration Treatment",                  ['TRTMTHD1','TRTCAT1','ESTAREA','SP1','SP2'],               'polygon',  '4.3.11',       R.findPDF('FIM_AR_TechSpec_2017.pdf#page=59')],
    "SCT":  ["Slash and Chip Treatment",                ['SLASHPIL','CHIPPIL','BURN','MECHANIC','REMOVAL'],         'arc',      '4.3.20',       R.findPDF('FIM_AR_TechSpec_2017.pdf#page=122')],
    "SGR":  ["Silvicultural Ground Rule Update",        ['SGR','TARGETFU','TARGETYD','TRIAL'],                      'polygon',  '4.3.19',       R.findPDF('FIM_AR_TechSpec_2017.pdf#page=118')],
    "SIP":  ["Site Preparation Treatment",              ['TRTMTHD1','TRTCAT1','PRODTYPE','RATE_AI','APPNUM'],       'polygon',  '4.3.12',       R.findPDF('FIM_AR_TechSpec_2017.pdf#page=68')],
    "TND":  ["Tending Treatment",                       ['TRTMTHD1','TRTCAT1','PRODTYPE','RATE_AI','APPNUM'],       'polygon',  '4.3.13',       R.findPDF('FIM_AR_TechSpec_2017.pdf#page=74')],
    "WTX":  ["Water Crossings",                         ['WATXID','WATXTYPE','CONSTRCT','MONITOR','REMOVE',
                                                            'REPLACE','REVIEW','ROADID','TRANS'],                   'point',    '4.3.10',       R.findPDF('FIM_AR_TechSpec_2017.pdf#page=52')]
        }

# vnull is used to check if an item is NULL or blank.
vnull = [None,'',' ']


def run(gdb, summarytbl, year, fmpStartYear, dataformat):  ## eg. summarytbl = {'MU615_15AGG00': ['AGG','Forestry Aggregate Pits','NAD 1983 Lambert Conformal Conic',['PIT_ID', 'REHABREQ', 'REHAB', 'TONNES'],['OBJECTID', 'SHAPE', 'MU615_15AGG00_', 'MU615_15AGG00_ID', 'PITCLOSE']],...}
    lyrList = summarytbl.keys()
    fieldValUpdate = dict(zip(lyrList,['' for i in lyrList]))  ## if we find a record-value-based mandatory field, field validation status should be updated.
    fieldValComUpdate = dict(zip(lyrList,[[] for i in lyrList])) ## if we find a record-value-based mandatory field, field validation comments should be updated.
    recordVal = dict(zip(lyrList,['' for i in lyrList]))  ## recordVal should be either Valid or Invalid for each layer.
    recordValCom = dict(zip(lyrList,[[] for i in lyrList]))  ## recordValCom should be in the form, "1 record(s) where AWS_YR = 2016".
    errorDetail = dict(zip(lyrList,[[] for i in lyrList])) ## this will be used to populate "Error Detail" section of the report.

    for lyr in summarytbl.keys(): # for each layer such as MU110_17SAC10...
        lyrAcro = summarytbl[lyr][0] ## eg. "AGP"
        criticalError = 0
        minorError = 0
        systemError = False
        # summarytbl[lyr][3] is a list of existing mandatory fields and summarytbl[lyr][4] is a list of existing other fields
        f = summarytbl[lyr][4] + summarytbl[lyr][3]  ## f is the list of all fields found in lyr. eg. ['FID', 'SHAPE','PIT_ID', 'PIT_OPEN', 'PITCLOSE', 'CAT9APP', ...]

        # each fieldname is a new variable where the value is its index number - for example, OBJECTID = 0.
        for i in range(len(f)):
            try:
                exec(f[i] + "=" + str(i)) ## POLYID = 0, POLYTYPE = 1, etc.
            except:
                pass # some field names are not valid as a variable name.

        # feature classes have ObjectID, shapefiles and coverages have FID. Search for ObjectID's index value in f, if not possible, search for FID's index value in f. else use whatever field comes first as the ID field.
        id_field = R.find_IdField(f, dataformat) # *23408  This will normally return OBJECTID for feature classes and FID for shapefile and coverage.
        id_field_idx = f.index(id_field)


        cursor = arcpy.da.SearchCursor(lyr,f)
        recordCount = len(list(cursor))
        cursor.reset()

        # Creating a new cursor. The new cursor has no artifact polygons created by donut holes in the coverages.
        artifact_count = 0
        # check for artifact polygons only if the data format is coverage, type is polygon, and if there's more than one mandatory field.
        if lyrInfo[lyrAcro][2] == 'polygon' and dataformat == 'coverage' and len(summarytbl[lyr][3]) > 1: # *23403
            result = R.create_cursor(lyr, summarytbl[lyr][3], f) # summarytbl[lyr][3] is the list of existing mandatory fields.
            if result != None:
                cursor2 = result
                recordCount2 = len(list(cursor2))
                cursor2.reset()
                # if the record count by the new cursor is different from the original cursor, use the new cursor
                if recordCount2 < recordCount:
                    cursor = cursor2
                    artifact_count = recordCount - recordCount2
        arcpy.AddMessage("\n  Checking each record in %s (%s records, %s artifacts)..."%(lyr,recordCount, artifact_count))
        recordValCom[lyr].append("Total %s records (with %s artifacts)."%(recordCount, artifact_count))



#       ######### Going through each layer type in alphabetical order ##########


        ###########################  Checking AGG   ############################

        if lyrAcro == "AGG":
            try: # need try and except block here for cases such as not having mandatory fields.
            # PITID
                # The population of this attribute is mandatory
                # A blank or null value is not a valid code
                errorList = ["Error on %s %s: The population of PITID is mandatory (A blank or null value is not a valid code)."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[PITID] in vnull]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    criticalError += 1
                    recordValCom[lyr].append("Error on %s record(s): The population of PITID is mandatory (A blank or null value is not a valid code)."%len(errorList))

                # The PITID attribute must contain a unique value
                pitIDList = [cursor[PITID] for row in cursor]
                cursor.reset()
                if len(set(pitIDList)) < len(pitIDList):
                    duplicateCount = len(pitIDList) - len(set(pitIDList))
                    criticalError += 1
                    recordValCom[lyr].append("Error on %s record(s): The PITID attribute must contain a unique value."%duplicateCount)

            # REHABREQ
                # The attribute population must follow the correct format (must be between 0 and 9.9) * The checker accepts null as zero.
                errorList = ["Error on %s %s: REHABREQ must be a number of hectares between 0 and 9.9."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[REHABREQ] not in vnull
                                if cursor[REHABREQ] < 0 or cursor[REHABREQ] > 9.9]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    criticalError += 1
                    recordValCom[lyr].append("Error on %s record(s): REHABREQ must be a number of hectares between 0 and 9.9."%len(errorList))

                # If the area requiring rehabilitation is greater than zero (REHABREQ>0) then the pit closure date should be null (PITCLOSE = null)
                if "PITCLOSE" in f:
                    errorList = ["Error on %s %s: PITCLOSE should be null if REHABREQ > 0 (error when both PITCLOSE and REHABREQ are populated)."%(id_field, cursor[id_field_idx]) for row in cursor
                                    if cursor[REHABREQ] not in vnull
                                    if cursor[REHABREQ] > 0 and cursor[PITCLOSE] not in vnull]
                    cursor.reset()
                    if len(errorList) > 0:
                        errorDetail[lyr].append(errorList)
                        criticalError += 1
                        recordValCom[lyr].append("Error on %s record(s): PITCLOSE should be null if REHABREQ > 0 (error when both PITCLOSE and REHABREQ are populated)."%len(errorList))

                # The hectares requiring rehabilitation should be less than or equal to three.
                errorList = ["Error on %s %s: REHABREQ should be less than or equal to 3."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[REHABREQ] not in vnull
                                if cursor[REHABREQ] > 3 ]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    minorError += 1
                    recordValCom[lyr].append("Error on %s record(s): REHABREQ should be less than or equal to 3."%len(errorList))

            # REHAB
                # The attribute population must follow the correct format
                # A zero value is a valid code. *the checker also accepts null value as zero.
                errorList = ["Error on %s %s: REHAB must be a number of hectares between 0 and 9.9."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[REHAB] not in vnull
                                if cursor[REHAB] < 0 or cursor[REHAB] > 9.9]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    criticalError += 1
                    recordValCom[lyr].append("Error on %s record(s): REHAB must be a number of hectares between 0 and 9.9."%len(errorList))

                # If the area rehabilitated is zero (REHAB = 0) then the tonnes of aggregate extracted should not be zero (TONNES != 0)
                errorList = ["Error on %s %s: If REHAB is zero or null then the TONNES should not be zero or null."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[REHAB] in [0, None] and cursor[TONNES] in [0, None]]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    minorError += 1
                    recordValCom[lyr].append("Error on %s record(s): If REHAB is zero or null then the TONNES should not be zero or null."%len(errorList))

                # The hectares rehabilitated should be less than or equal to three.
                errorList = ["Error on %s %s: REHAB should be less than or equal to 3."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[REHAB] not in vnull
                                if cursor[REHAB] > 3 ]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    minorError += 1
                    recordValCom[lyr].append("Error on %s record(s): REHAB should be less than or equal to 3."%len(errorList))

            # PITCLOSE
                if 'PITCLOSE' in f:
                    # The attribute population must follow the correct format
                    # A blank or null value is a valid code
                    errorList = ["Error on %s %s: PITCLOSE attribute must follow the correct format (a blank or null is valid)."%(id_field, cursor[id_field_idx]) for row in cursor
                                    if cursor[PITCLOSE] not in vnull and R.fimdate(cursor[PITCLOSE]) is None]
                    cursor.reset()
                    if len(errorList) > 0:
                        errorDetail[lyr].append(errorList)
                        criticalError += 1
                        recordValCom[lyr].append("Error on %s record(s): PITCLOSE attribute must follow the correct format (a blank or null is valid)."%len(errorList))

                    # The pit closure date should be within the fiscal year
                    errorList = ["Error on %s %s: PITCLOSE date should be within the fiscal year."%(id_field, cursor[id_field_idx]) for row in cursor
                                    if cursor[PITCLOSE] not in vnull and R.fimdate(cursor[PITCLOSE]) is not None # if PITCLOSE is populated with the correct format
                                    if R.fimdate(cursor[PITCLOSE]) < R.fimdate(str(year) + 'APR01')
                                    or R.fimdate(cursor[PITCLOSE]) > R.fimdate(str(year+1) + 'MAR31')]
                    cursor.reset()
                    if len(errorList) > 0:
                        errorDetail[lyr].append(errorList)
                        criticalError += 1
                        recordValCom[lyr].append("Error on %s record(s): PITCLOSE date should be within the fiscal year (%s)."%(len(errorList),year))

                    # The following has been commented out because it's a duplicate check as the one in REHABREQ.
                    # # When the final rehabilitation date is populated (PITCLOSE != null) then the required rehabilitation will be zero (REHABREQ = 0)
                    # errorList = ["Error on %s %s: REHABREQ must be zero or null if PITCLOSE is populated."%(id_field, cursor[id_field_idx]) for row in cursor
                    #                 if cursor[PITCLOSE] not in vnull and R.fimdate(cursor[PITCLOSE]) is not None
                    #                 if cursor[REHABREQ] not in [0, None]]
                    # cursor.reset()
                    # if len(errorList) > 0:
                    #     errorDetail[lyr].append(errorList)
                    #     criticalError += 1
                    #     recordValCom[lyr].append("Error on %s record(s): REHABREQ must be zero or null if PITCLOSE is populated."%len(errorList))

            # TONNES
                # The attribute population must follow the correct format
                # A zero value is a valid code
                errorList = ["Error on %s %s: TONNES must be a number between 0 and 99,999,999."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[TONNES] not in vnull
                                if cursor[TONNES] < 0 or cursor[TONNES] > 99999999]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    criticalError += 1
                    recordValCom[lyr].append("Error on %s record(s): TONNES must be a number between 0 and 99,999,999."%len(errorList))

            except ValueError:
                recordValCom[lyr].append("***Unable to run full validation on %s due to missing mandatory field(s)"%lyr)
                criticalError += 1
            except NameError:
                recordValCom[lyr].append("***Unable to run full validation on %s due to unexpected error."%lyr)
                systemError = True



        ###########################  Checking FTG   ############################

        if lyrAcro == "FTG":
            try: # need try and except block here for cases such as not having mandatory fields.

            # ARDSTGRP
                # The population of this attribute is mandatory
                # The attribute population must follow the correct coding scheme
                # A blank or null value is not a valid code
                errorList = ["Error on %s %s: ARDSTGRP must be populated with HARV or NAT."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[ARDSTGRP] not in ['HARV','NAT']]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    criticalError += 1
                    recordValCom[lyr].append("Error on %s record(s): ARDSTGRP must be populated with HARV or NAT."%len(errorList))

            # YRDEP
                # The population of this attribute is mandatory
                # The attribute population must follow the correct format
                # A zero (or null) value is not a valid code
                errorList = ["Error on %s %s: YRDEP must be populated with the correct format (YYYY) and a zero or Null is not a valid value."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[YRDEP] in vnull or cursor[YRDEP] < 1000 or cursor[YRDEP] > 9999]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    criticalError += 1
                    recordValCom[lyr].append("Error on %s record(s): YRDEP must be populated with the correct format (YYYY) and a zero or Null is not a valid value."%len(errorList))

                # The year of last disturbance should be greater than the annual report start year minus twenty (the error occurs when YRDEP <= ARYEAR - 20)
                errorList = ["Warning on %s %s: YRDEP should be greater than AR year minus 20."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[YRDEP] not in vnull
                                if cursor[YRDEP] > 999 and cursor[YRDEP] <= year - 20 ] # "cursor[YRDEP] > 999" check prevents catching the same error as above
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    minorError += 1
                    recordValCom[lyr].append("Warning on %s record(s): YRDEP should be greater than AR year minus 20."%len(errorList))

            # DSTBFU
                # The population of this attribute is mandatory
                # A blank or null value is not a valid code.
                errorList = ["Error on %s %s: DSTBFU must be populated."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[DSTBFU] in vnull]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    criticalError += 1
                    recordValCom[lyr].append("Error on %s record(s): DSTBFU must be populated."%len(errorList))

            # SGR
                # The population of this attribute is mandatory
                # A blank or null value is not a valid code.            
                errorList = ["Error on %s %s: SGR must be populated."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[SGR] in vnull]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    criticalError += 1
                    recordValCom[lyr].append("Error on %s record(s): SGR must be populated."%len(errorList))

            # TARGETFU
                # The population of this attribute is mandatory
                # A blank or null value is not a valid code.            
                errorList = ["Error on %s %s: TARGETFU must be populated."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[TARGETFU] in vnull]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    criticalError += 1
                    recordValCom[lyr].append("Error on %s record(s): TARGETFU must be populated."%len(errorList))

            # FTG
                # The population of this attribute is mandatory
                # The attribute population must follow the correct coding scheme.
                # A blank or null value is not a valid code
                errorList = ["Error on %s %s: FTG must be populated with Y or N."%(id_field, cursor[id_field_idx]) for row in cursor
                                if cursor[FTG] not in ['Y','N']]
                cursor.reset()
                if len(errorList) > 0:
                    errorDetail[lyr].append(errorList)
                    criticalError += 1
                    recordValCom[lyr].append("Error on %s record(s): FTG must be populated with Y or N."%len(errorList))

            # FTG - Y counter
                ftg_y = ["y" for row in cursor if cursor[FTG] =='Y']
                cursor.reset()
                ftg_y_count = len(ftg_y)

            # FTGFU
                # Where FTG = Y: The population of this attribute is mandatory
                # Where FTG = Y: A blank or null value is not a valid code.             
                if 'FTGFU' in f:
                    errorList = ["Error on %s %s: FTGFU must be populated where FTG = Y."%(id_field, cursor[id_field_idx]) for row in cursor
                                    if cursor[FTGFU] in vnull and cursor[FTG] == 'Y']
                    cursor.reset()
                    if len(errorList) > 0:
                        errorDetail[lyr].append(errorList)
                        criticalError += 1
                        recordValCom[lyr].append("Error on %s record(s): FTGFU must be populated where FTG = Y."%len(errorList))

                # The presence of thie attribute in the file structure of the layer is mandatory (where FTG=Y)
                elif ftg_y_count > 0:
                    fieldValComUpdate[lyr].append("Missing FTGFU: FTGFU field is mandatory where FTG = Y.")
                    fieldValUpdate[lyr] = 'Invalid'

            # SPCOMP
                if 'SPCOMP' in f:
                    # The population of this attribute is mandatory where FTG = Y
                    errorList = ["Error on %s %s: SPCOMP must be populated when FTG = Y."%(id_field, cursor[id_field_idx]) for row in cursor
                                    if cursor[FTG] == 'Y'
                                    if cursor[SPCOMP] in vnull]
                    cursor.reset()
                    if len(errorList) > 0:
                        errorDetail[lyr].append(errorList)
                        criticalError += 1
                        recordValCom[lyr].append("Error on %s record(s): SPCOMP must be populated when FTG = Y (A1.9.8)."%len(errorList))

                    # The attribute population must follow the correct format
                    ## code to check spcomp
                    fieldname = "SPCOMP"
                    e1List, e2List, e3List, e4List, w1List = [],[],[],[],[]
                    for row in cursor:
                        if cursor[f.index(fieldname)] not in vnull:
                            check = R.spcVal(cursor[f.index(fieldname)],fieldname)
                            if check is None: ## when no error found
                                pass
                            elif check[0] == "Error1":
                                e1List.append("Error on %s %s: %s"%(id_field, cursor[id_field_idx],check[1]))
                            elif check[0] == "Error2":
                                e2List.append("Error on %s %s: %s"%(id_field, cursor[id_field_idx],check[1]))
                            elif check[0] == "Error3":
                                e3List.append("Error on %s %s: %s"%(id_field, cursor[id_field_idx],check[1]))
                            elif check[0] == "Error4":
                                e4List.append("Error on %s %s: %s"%(id_field, cursor[id_field_idx],check[1]))
                            elif check[0] == "Warning1":
                                w1List.append("Warning on %s %s: %s"%(id_field, cursor[id_field_idx],check[1]))
                    cursor.reset()
                        # summarizing errors
                    if len(e1List + e2List + e3List + e4List) > 0:
                        criticalError += 1
                    for errorlist in [e1List, e2List, e3List, e4List]:
                        if len(errorlist) > 0:
                            errorDetail[lyr].append(errorlist)
                            recordValCom[lyr].append("Error on %s record(s):%s."%(len(errorlist),errorlist[0][errorlist[0].find(':')+1:]))
                        # summarizing warnings
                    if len(w1List) > 0:
                        minorError += 1
                        errorDetail[lyr].append(w1List)
                        recordValCom[lyr].append("Warning on %s record(s):%s."%(len(w1List),w1List[0][w1List[0].find(':')+1:]))

                # The presence of this attribute in the file structure of the layer is mandatory where FTG = Y
                elif ftg_y_count > 0:
                    fieldValComUpdate[lyr].append("Missing SPCOMP: SPCOMP field is mandatory where FTG = Y.")
                    fieldValUpdate[lyr] = 'Invalid'

            # HT
                if 'HT' in f:
                    # The attribute population must follow the correct format
                    errorList = ["Error on %s %s: HT must be between 0 and 40 if populated."%(id_field, cursor[id_field_idx]) for row in cursor
                                    if cursor[HT] not in vnull
                                    if cursor[HT] < 0 or cursor[HT] > 40]
                    cursor.reset()
                    if len(errorList) > 0:
                        errorDetail[lyr].append(errorList)
                        criticalError += 1
                        recordValCom[lyr].append("Error on %s record(s): HT must be between 0 and 40 if populated."%len(errorList))

                    # Where FTG = Y: The population of this attribute is mandatory
                    # Where FTG = Y: A zero (or null) value is not a valid code
                    # Where FTG = Y: When the free-to-grow indicator is yes (FTG = Y) then the height must be greater than or equal ot 80cm
                    errorList = ["Error on %s %s: HT must be greater than or equal to 0.8 when FTG = Y."%(id_field, cursor[id_field_idx]) for row in cursor
                                    if cursor[FTG] == 'Y'
                                    if cursor[HT] in vnull or cursor[HT] < 0.8]
                    cursor.reset()
                    if len(errorList) > 0:
                        errorDetail[lyr].append(errorList)
                        criticalError += 1
                        recordValCom[lyr].append("Error on %s record(s): HT must be greater than or equal to 0.8 when FTG = Y."%len(errorList))

                # Where FTG = Y: The presence of this attribute in the file structure of the layer is mandatory
                elif ftg_y_count > 0:
                    fieldValComUpdate[lyr].append("Missing HT: HT field is mandatory where FTG = Y.")
                    fieldValUpdate[lyr] = 'Invalid'

            # STKG
                if 'STKG' in f:
                    # The attribute population must follow the correct format
                    errorList = ["Error on %s %s: STKG must be between 0 and 4 if populated."%(id_field, cursor[id_field_idx]) for row in cursor
                                    if cursor[STKG] not in vnull
                                    if cursor[STKG] < 0 or cursor[STKG] > 4]
                    cursor.reset()
                    if len(errorList) > 0:
                        errorDetail[lyr].append(errorList)
                        criticalError += 1
                        recordValCom[lyr].append("Error on %s record(s): STKG must be between 0 and 4 if populated (A1.9.9)."%len(errorList))

                    # Where FTG = Y: The population of this attribute is mandatory
                    # Where FTG = Y: A zero (or null) value is not a valid code
                    # Where FTG = Y: The stocking must be greater than or equal to forty percent (STKG >= 0.4)
                    errorList = ["Error on %s %s: STKG must be greater than or equal to 0.4 when FTG = Y."%(id_field, cursor[id_field_idx]) for row in cursor
                                    if cursor[FTG] == 'Y'
                                    if cursor[STKG] in vnull or cursor[STKG] < 0.4]
                    cursor.reset()
                    if len(errorList) > 0:
                        errorDetail[lyr].append(errorList)
                        criticalError += 1
                        recordValCom[lyr].append("Error on %s record(s): STKG must be greater than or equal to 0.4 when FTG = Y."%len(errorList))

                # Where FTG = Y: The presence of this attribute in the file structure of the layer is mandatory
                elif ftg_y_count > 0:
                    fieldValComUpdate[lyr].append("Missing STKG: STKG field is mandatory where FTG = Y.")
                    fieldValUpdate[lyr] = 'Invalid'


            except ValueError:
                recordValCom[lyr].append("***Unable to run full validation on %s due to missing mandatory field(s)"%lyr)
                criticalError += 1
            except NameError:
                recordValCom[lyr].append("***Unable to run full validation on %s due to unexpected error."%lyr)
                systemError = True



        ###########################  Checking HRV   ############################

        if lyrAcro == "HRV":
            try: # need try and except block here for cases such as not having mandatory fields.

            #BLOCKID  **new in 2017
                # The population of this attribute is mandatory where plan start year is greater than or equal to 2019
                # A blank or null value is not a valid code where plan start is greater than or equal to 2019
                if fmpStartYear >= 2019:
                    errorList = ["Error on %s %s: BLOCKID must be populated where plan start year is greater than or equal to 2019."%(id_field, cursor[id_field_idx]) for row in cursor
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 